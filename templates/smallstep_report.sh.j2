#!/bin/sh

export PATH=/usr/bin:/bin
umask 077

# inline stdout redirection for sh
# https://stackoverflow.com/questions/3173131/redirect-copy-of-stdout-to-log-file-from-within-bash-script-itself
check_tee_output()
{
    # copy (append) stdout and stderr to log file if TEE is unset or true
    if [ -z "${TEE}" ] || [ "${TEE}" = true ]; then
	TEE=false $0 2>&1 | tee {{ smallstep_reporting_dest }}/smallstep-report-"$(date +%Y%m%d)" >/dev/null
        exit $?
    fi
}

check_tee_output

date=$(date +%Y%m%d)
journalctl_args="-l --no-pager"
service=step-ca
nginx_jsonlog=/var/log/nginx/stepca.access_json.log
echo
echo
echo "      SMALLSTEP DAILY REPORT ${date} from journalctl and nginx logs"
echo
echo

# Ubuntu 22.04

echo "** Sample"
journalctl -eu "${service}" ${journalctl_args} --since '1 day ago' | tail -3
echo
echo

echo "** Event path"
journalctl -eu "${service}" ${journalctl_args} --since '1 day ago' | sed 's@.*path=\(.*\) protocol=.*remote-address=\(.*\) request-id=.* status=\([0-9]*\) .*user-agent=\(.*\) user-id=.*@\1@' | sort | uniq -c | sort -nr
echo
echo

echo "** Events"
journalctl -eu "${service}" ${journalctl_args} --since '1 day ago' | sed 's@.*path=\(.*\) protocol=.*remote-address=\(.*\) request-id=.* status=\([0-9]*\) .*user-agent=\(.*\) user-id=.*@\1,\2,\3,\4@' | sort | uniq -c | sort -nr
echo
echo

echo "** Remote address"
journalctl -eu "${service}" ${journalctl_args} --since '1 day ago' | sed 's@.*path=\(.*\) protocol=.*remote-address=\(.*\) request-id=.* status=\([0-9]*\) .*user-agent=\(.*\) user-id=.*@\2@' | sort | uniq -c | sort -nr
echo
echo

if [ -f "${nginx_jsonlog}" ]; then
echo "** Nginx path"
jq -r '.uri' "${nginx_jsonlog}" | sort | uniq -c | sort -nr
echo "** Nginx remote_addr"
jq -r '.remote_addr' "${nginx_jsonlog}" | sort | uniq -c | sort -nr
echo "** Nginx status"
jq -r '.status' "${nginx_jsonlog}" | sort | uniq -c | sort -nr
echo "** Nginx http_user_agent"
jq -r '.http_user_agent' "${nginx_jsonlog}" | sort | uniq -c | sort -nr
echo "** Nginx failed queries"
jq -r 'select(.status != "200" and .status != "201") | .uri + " " + .status + " by: " + .remote_addr + " ua: " + .http_user_agent' "${nginx_jsonlog}" | sort | uniq -c | sort -nr
echo
echo
fi

find {{ smallstep_reporting_dest }} -name 'smallstep-report-*' -mtime +{{ smallstep_logrotate_days|int }} -exec rm {} \; 2>/dev/null
